/*=======================================================================*\
|| ###################################################################### ||
|| # vBulletin 5.2.3
|| # ------------------------------------------------------------------ # ||
|| # Copyright 2000-2016 vBulletin Solutions Inc. All Rights Reserved.  # ||
|| # This file may not be redistributed in whole or significant part.   # ||
|| # ----------------- VBULLETIN IS NOT FREE SOFTWARE ----------------- # ||
|| # http://www.vbulletin.com | http://www.vbulletin.com/license.html   # ||
|| ###################################################################### ||
\*========================================================================*/
window.vBulletin=window.vBulletin||{};window.vBulletin.phrase=window.vBulletin.phrase||{};window.vBulletin.phrase.precache=window.vBulletin.phrase.precache||[];window.vBulletin.phrase.precache=$.merge(window.vBulletin.phrase.precache,["error","pmchat_close_button_label","pmchat_idle_disconnected_message","pmchat_idle_disconnected_title","pmchat_reconnect_button_label"]);window.vBulletin.options=window.vBulletin.options||{};window.vBulletin.options.precache=window.vBulletin.options.precache||[];window.vBulletin.options.precache=$.merge(window.vBulletin.options.precache,["pmchat_enabled","pmchat_header_polling_interval","pmchat_chat_polling_idle_timeout","pmchat_chat_polling_min_interval","pmchat_chat_polling_max_interval"]);(function(F){var A=pageData.baseurl+"/pmchat/chat";function E(H){var I="";if(H.hasOwnProperty("messageid")){I="?messageid="+encodeURIComponent(H.messageid)}else{I="?aboutNodeid="+encodeURIComponent(H.aboutNodeid)+"&toUserid="+encodeURIComponent(H.toUserid)}if(I==""){return"#"}return A+I}function C(K){var H,I="width=600,height=700,resizable=yes,scrollbars=yes,status=yes,location=yes",J;if(K.hasOwnProperty("url")){H=K.url}else{H=E(K)}if(H=="#"){return }J=window.open(H,"_blank",I);if(!J||J.closed||typeof J.closed=="undefined"){window.open(H+queryString)}}function B(){var L=F(".js-pmchat__dropdown");var g=L.find(".js-pmchat__messages-count");var f=F(".notifications-count").not(".js-pmchat__messages-count");var c=L.find(".js-pmchat__dropdown-submenu");var T=c.find(".js-pmchat__dropdown__single-pm-template").removeClass("js-pmchat__dropdown__single-pm-template h-hide");var h=c.find(".js-pmchat__insert-marker");var S=".js-pmchat__submenu__ephemeral";var M=L.find(".js-pmchat__submenu__loading-icon");var Q=L.find(".js-pmchat__header-data");var a=parseInt(Q.data("messages-folderid"),10);var d=vBulletin.options.get("pmchat_header_polling_interval")||30;var P;var J=0;var b=60;var Z=vBulletin.options.get("pmchat_chat_polling_idle_timeout")||5*60;var e=0;var U={};var V=0;function R(){var j={},i=F(this).attr("href");if(i!="#"){j.url=i}else{j.messageid=F(this).data("starter")}C(j);F(this).parent().removeClass("b-menu__messages-submenu--unread");return false}function I(o){e=Date.now();var l=o[Object.keys(o)[0]],n=l&&l.orderListForJs||[],r=n.length,p=false,u=false,m={};if(r>0){c.find(S).remove()}else{return false}for(var q=0;q<r;q++){var k=n[q];if(o.hasOwnProperty(k)){var v=o[k],j=T.clone(true),s=j.find(".js-pmchat__submenu__link"),t="js-pmchat__messagefinder__"+k;s.attr("data-starter",k).prop("title",v.previewtext).attr("href",E({messageid:k}));j.find(".js-pmchat__submenu__title").html(v.title);if(v.msgread==0){j.addClass("b-menu__messages-submenu--unread")}j.addClass(t);j.insertBefore(h);u=(V>0&&(!U.hasOwnProperty(k)||U[k]["publishdate"]!=v.publishdate||U[k]["userid"]!=v.userid)&&v.msgread==0&&v.userid!=pageData.userid);if(u){p=true}m[k]={publishdate:v.publishdate,userid:v.userid,title:v.title,previewtext:v.previewtext,findmehelper:t,isNew:u}}}U=m;V=e;if(p){X()}}function X(){console.log("New Messages found in polling! Notifying user");var p=L.hasClass("b_menu__dropdown--active");if(p){var n,k=[];for(n in U){if(U.hasOwnProperty(n)&&U[n]["isNew"]){k.push("."+U[n]["findmehelper"])}}if(k.length>0){var o=k.join(", "),m=F(o),l=setInterval(function(){m.toggleClass("b-menu__messages-submenu--unread-alert")},100),j=function(){clearInterval(l);m.removeClass("b-menu__messages-submenu--unread-alert")},i=3;setTimeout(j,i*1000)}}else{L.addClass("b_menu__dropdown--alert")}}function O(k){L.removeClass("b_menu__dropdown--alert");J=0;var i=d;if((Date.now()-e)<i*1000){console.log("PM Load aborted: less than "+i+" seconds since last load.");return }M.removeClass("h-hide");var j=function(){M.addClass("h-hide");W()};K(j)}function H(){console.log("Idle detection enabled");var i=setInterval(Y,b*1000);F(document).mousemove(function(j){J=0});F(document).keypress(function(j){J=0})}function Y(){J+=b;if(J>=Z){W()}}function W(){clearTimeout(P);if(J>=Z){console.log("Header polling stopped due to idle timeout. (idle time: "+J+"s)");return }P=setTimeout(N,d*1000)}function N(){W();console.log("Polled for header data!"+Date.now());K()}function K(j){var i=false;vBulletin.loadingIndicator.suppressNextAjaxIndicator();vBulletin.AJAX({url:vBulletin.getAjaxBaseurl()+"/chat/loadheaderdata",success:function(l){if(l&&!l.errors){var k=l.headerCounts.messages,o=g.text(),m=l.headerCounts.nonpms_sum,n=f.text();if(o!=k){g.text(k);if(k>0){g.removeClass("h-hide-imp")}else{g.addClass("h-hide-imp")}i=true}if(n!=m){f.text(m);if(m>0){f.removeClass("h-hide-imp")}else{f.addClass("h-hide-imp")}i=true}if(i){console.log("Header messages/notification count(s) changed with updated data from loadheaderdata")}else{}if(!(F.isEmptyObject(l.messages))){I(l.messages)}}},emptyResponse:function(){console.log("/ajax/api/content_privatemessage/listMessages returned an empty response!")},error:function(k,m,l){console.log("/ajax/content_privatemessage/listMessages failed!");console.log("----------------");console.log("jqXHR:");console.dir(k);console.log("text status:");console.dir(m);console.log("error thrown:");console.dir(l);console.log("----------------")},complete:j})}c.off("click").on("click",".js-pmchat__submenu__link",R);L.on("event-js-menu__dropdown__open",O);H();P=setTimeout(N,d*1000)}function D(){var L=F(".js-pmchat__container");var t=L.find(".js-pmchat__thread-container");var p=L.find("form");var J=L.find(".js-pmchat__data");var Z=parseInt(J.data("pmchannelid"),10);var j=parseInt(J.data("parentid"),10);var Y=parseInt(J.data("pm_messageid"),10);var P=parseInt(J.data("to_userid"),10);var l=J.data("pm_title");var X=0;var a=F(".js-pmchat__insert-marker");var b=t.find(".js-pmchat__thread-placeholder");var c;var Q=false;if(Z==j||!(Y>0)){Q=true}var T=0;var w;var I=Date.now();var m;var n;var u=1;var W=vBulletin.options.get("pmchat_chat_polling_min_interval")||1;var d=vBulletin.options.get("pmchat_chat_polling_max_interval")||30;if(d<W){var N=d;d=W;W=N}n=(W*10+d*1)/11;m=n;var V=vBulletin.options.get("pmchat_chat_polling_idle_timeout")||5*60;var k=0;var H=10;var M=H-1;var g=[];var s;for(s=0;s<H;++s){g[s]=0}var O={messagesLoading:false,queued:false};function v(){var z=F(".js-pmchat__insert-marker"),y=z.offset().top,x=F(".js-pm-content-entry-container"),AA=x.outerHeight(),AC=(x.css("position")=="fixed"),AB=F(window).outerHeight(),i=(y>(AB-AA));if(!AC||i){vBulletin.animateScrollTop(y)}}function e(x){if(Q){console.log("Nothing to load, awaiting first message.");return }if(O.messagesLoading){console.log("loadNewMessages() rejected: Still awaiting messages from a previous call.");return }console.log("loadNewMessages() executing.");var i=[];t.find(".js-pmchat__post-wrapper").each(function(AB,AA){var z=F(AA).data("publishdate");if(z&&z>X){X=z}var y=F(AA).data("nodeid");if(y&&y>0){i.push(y)}if(z&&X>z){F(AA).removeClass("js-pmchat__post-wrapper")}});O.messagesLoading=true;vBulletin.loadingIndicator.suppressNextAjaxIndicator();vBulletin.AJAX({url:vBulletin.getAjaxBaseurl()+"/chat/loadnewmessages",data:{parentid:j,newreplyid:x,lastpublishdate:X,loadednodes:i,},success:function(y){M=(M+1)%H;if(y.html&&y.html!==""){g[M]=1;k=Date.now();console.log("loadNewMessages(): Inserting new messages.");F(y.html).insertBefore(a);v()}else{g[M]=-1;console.log("loadNewMessages(): No new messages.")}if(y.nodeids){}},error:function(y){console.log("loadNewMessages(): Error loading new PMs. Ajax result:");console.log(y)},complete:function(y){window.vBulletin.loadingIndicator.hide();O.messagesLoading=false;if(O.queued){O.queued=false;window.vBulletin.loadingIndicator.show();setTimeout(e,0)}R()}})}function R(){clearTimeout(w);var AA=Date.now(),y=(AA-k),i=(AA-T),z=(g[M]>0),AB=g.reduce(function(AD,AC){return AD+AC})/H;if(k>0){if(z){if(m>n){m=n}m-=u;if(k>I){I=k}}else{m-=(AB*u)}}else{m+=u}if(m<W){m=W}else{if(m>d){m=d}}T=AA;var x=(AA-I)/1000;console.log("Idle time: "+x+"s. (timeout: "+V+"s)");if(x>=V){console.log("Polling for messages stopped due to idle timeout. Idle start time: "+I+" time now: "+AA);r();I=AA;return }w=setTimeout(K,m*1000);console.log("Polling for messages complete. Next poll in "+m+"seconds. Time since last poll: "+(i/1000)+"s, since last hit: "+(y/1000)+"s.")}function K(){R();e()}function r(){if(c==null){var x=function(){I=Date.now();m=n;K()};var i={title:vBulletin.phrase.get("pmchat_idle_disconnected_title"),message:vBulletin.phrase.get("pmchat_idle_disconnected_message"),width:"50%",buttonLabel:{yesLabel:vBulletin.phrase.get("pmchat_reconnect_button_label"),noLabel:vBulletin.phrase.get("pmchat_close_button_label")},onClickYes:x,onClickNo:function(){window.close()}};c=openConfirmDialog(i)}else{c.dialog("open")}}function h(){var i=p.attr("ck-editorid")||F(".js-editor",p).attr("id"),x=F("#"+i);x.on("afterInit",function(){var z=vBulletin.ckeditor.getEditor(i);if(!z){console.log("Editor not found, cannot set predefined starter PM text");return }console.log("Setting predefined starter PM text: "+J.data("pm_textprefill"));var y=J.data("pm_textprefill");if(y){y+="&nbsp;"}z.setData(y,function(){vBulletin.ckeditor.fixTableFunctionality.call(vBulletin.ckeditor,{},z);z.focus();if(y){var AA=z.createRange();AA.moveToPosition(AA.root,CKEDITOR.POSITION_BEFORE_END);z.getSelection().selectRanges([AA])}v()})})}function q(x){var i=F(this);i.prop("disabled",true);I=Date.now();if(Q){F("<input>").attr({type:"hidden",name:"sentto[]",value:P}).appendTo(p);F("<input>").attr({type:"hidden",name:"title",value:l}).appendTo(p)}else{var y=p.find('input[name="respondto"]');if(y.length>0){y.val(Y)}else{F("<input>").attr({type:"hidden",name:"respondto",value:Y}).appendTo(p)}}if(Q){b.addClass("h-hide")}window.vBulletin.loadingIndicator.show();vBulletin.AJAX({url:p.attr("action"),data:p.serialize(),success:function(z){if(z&&z.nodeId){var AA=parseInt(z.nodeId,10);if(Q){p.find('input[name="parentid"]').val(AA);J.data("parentid",AA);J.data("pm_messageid",AA);J.attr("data-parentid",AA);J.attr("data-pm_messageid",AA);Y=AA;j=AA;Q=false;var AB=pageData.baseurl+"/pmchat/chat?messageid="+AA;History.replaceState({},l,AB)}console.log("==================NEW MESSAGE POSTED, LOADING NEW MESSAGES!");if(O.messagesLoading){O.queued=true}else{e(AA)}vBulletin.contentEntryBox.resetForm(p,false,function(){var AD=p.attr("ck-editorid")||F(".js-editor",p).attr("id");var AC=vBulletin.ckeditor.getEditor(AD);vBulletin.hv.reset();AC.focus()})}},api_error:function(AB,AA,z){vBulletin.errorAlert(vBulletin.phrase.get("error"),AB)},complete:function(z){i.prop("disabled",false)}});return false}function S(y){y.preventDefault();var i=F(this).attr("href"),x;x=window.open(i,"_blank");if(!x||x.closed||typeof x.closed=="undefined"){window.open(i)}}function f(){var x=F(".js-pmchat__participants");x.tinyscrollbar({sizethumb:14,axis:"x"});function i(){x.tinyscrollbar_update("relative")}vBulletin.Responsive.Debounce.registerCallback(i);x.find("img").on("load",i)}function o(x){var y=x+"-replacement",i=F("."+x),AA=F("."+y);if(AA.length==0){AA=F("<div />").addClass(y).insertAfter(i)}function z(){if(i.css("position")=="fixed"){AA.removeClass("h-hide");var AB=i.outerHeight()-30;AA.css("height",AB+"px")}else{AA.addClass("h-hide")}}F(z);F(document).off("click",z).on("click",z);vBulletin.Responsive.Debounce.registerCallback(z);CKEDITOR.on("instanceReady",function(AB){z();AB.editor.on("focus",function(){setTimeout(function(){z()},0)})})}function U(){var x=F("#debug-information-wrapper");if(x.length==1){function i(){if(F("body").is(".l-xsmall")){x.appendTo("body");x.find("#debug-information").css("margin-top",20)}else{x.insertBefore(".js-pm-content-entry-container");x.find("#debug-information").css("margin-top",0)}}i();vBulletin.Responsive.Debounce.registerCallback(i)}}F(".js-pm-content-entry-container .js-pmchat-submit").off("click").on("click",q);F(".js-pmchat__thread-container").on("click","a",S);F(".js-pm-content-entry-container .js-button").enable();v();K();f();window.setTimeout(h,0);o("js-pm-content-entry-container");o("js-pmchat__header");U()}function G(){F(function(){F(".js-pmchat-link").off("click").on("click",function(I){I.preventDefault();var H={url:F(this).attr("href")};C(H);return false});if(F(".js-pmchat__dropdown").length>0){console.log("Initializing PM Dropdown!");B()}else{console.log("PM Dropdown not detected, skipping init.")}if(F(".js-pmchat__container").length>0){console.log("Initializing PM Chat window!");D()}else{console.log("PM Chat window not detected, skipping init.")}})}G()})(jQuery);